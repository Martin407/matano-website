"use strict";(self.webpackChunk_matano_website=self.webpackChunk_matano_website||[]).push([[2180],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>d});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var c=a.createContext({}),s=function(e){var n=a.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},u=function(e){var n=s(e.components);return a.createElement(c.Provider,{value:n},e.children)},m={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},p=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,c=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),p=s(t),d=r,h=p["".concat(c,".").concat(d)]||p[d]||m[d]||o;return t?a.createElement(h,i(i({ref:n},u),{},{components:t})):a.createElement(h,i({ref:n},u))}));function d(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,i=new Array(o);i[0]=p;var l={};for(var c in n)hasOwnProperty.call(n,c)&&(l[c]=n[c]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var s=2;s<o;s++)i[s]=t[s];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}p.displayName="MDXCreateElement"},7209:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>l,default:()=>p,frontMatter:()=>i,metadata:()=>c,toc:()=>u});var a=t(87462),r=(t(67294),t(3905)),o=t(29332);const i={title:"Introducing enrichment tables and threat intelligence",authors:"samrose",keywords:["threat intelligence","enrichment"],tags:["announcement"],image:"./sg.jpeg"},l=void 0,c={permalink:"/blog/2022/12/23/enrichment-tables",editUrl:"https://github.com/matanolabs/matano-website/tree/main/website/blog/2022-12-23-enrichment-tables/index.md",source:"@site/blog/2022-12-23-enrichment-tables/index.md",title:"Introducing enrichment tables and threat intelligence",description:"You can now use enrichment tables in Matano to ingest custom data and threat intelligence to enrich your data, detections, and alerts. You can use this information to enhance correlation, improve alerts, and reduce false positives.",date:"2022-12-23T00:00:00.000Z",formattedDate:"December 23, 2022",tags:[{label:"announcement",permalink:"/blog/tags/announcement"}],readingTime:4.365,hasTruncateMarker:!0,authors:[{name:"Samrose Ahmed",email:"samrose@matano.dev",key:"samrose"}],frontMatter:{title:"Introducing enrichment tables and threat intelligence",authors:"samrose",keywords:["threat intelligence","enrichment"],tags:["announcement"],image:"./sg.jpeg"},nextItem:{title:"Automated Iceberg table maintenance",permalink:"/blog/2022/11/04/automated-iceberg-table-maintenance"}},s={image:t(53909).Z,authorsImageUrls:[void 0]},u=[{value:"How it works",id:"how-it-works",level:2},{value:"An example with IP intelligence data",id:"an-example-with-ip-intelligence-data",level:3},{value:"Another example with AWS account Info",id:"another-example-with-aws-account-info",level:3},{value:"Up next",id:"up-next",level:2}],m={toc:u};function p(e){let{components:n,...t}=e;return(0,r.kt)("wrapper",(0,a.Z)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"You can now use enrichment tables in Matano to ingest custom data and threat intelligence to enrich your data, detections, and alerts. You can use this information to enhance correlation, improve alerts, and reduce false positives."),(0,r.kt)("br",null),(0,r.kt)("div",{align:"center"},(0,r.kt)("img",{className:"mtn-blog-sq-img",src:o.Z})),(0,r.kt)("br",null),(0,r.kt)("p",null,"This new feature is designed to provide more comprehensive and relevant information for security monitoring and analysis. With enrichment tables, you can easily ingest data from a variety of sources, including custom logs, APIs, and threat intelligence feeds, to provide additional context and detail for your security events. This allows you to quickly and easily identify potential threats and respond to them in a timely manner."),(0,r.kt)("h2",{id:"how-it-works"},"How it works"),(0,r.kt)("p",null,"Enrichment tables are Matano Apache Iceberg tables, and work similarly to Matano log sources. In short, you:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Upload data (JSON, CSV, text) for ingestion as files to an S3 prefix."),(0,r.kt)("li",{parentName:"ul"},"Define a schema for the enrichment table."),(0,r.kt)("li",{parentName:"ul"},"Optionally transform the data using VRL."),(0,r.kt)("li",{parentName:"ul"},"Use the enrichment table in alerts and detections.")),(0,r.kt)("p",null,"You can either have tables append data new data or overwrite/replace the table on each write."),(0,r.kt)("p",null,"Some common usecases for enrichment are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Look up contextual data to eliminate false positives in detections."),(0,r.kt)("li",{parentName:"ul"},"Dynamically set severity of an alert by lookup up data from an enrichment table."),(0,r.kt)("li",{parentName:"ul"},"Improve response by adding contextual information from an enrichment table to an alert.")),(0,r.kt)("h3",{id:"an-example-with-ip-intelligence-data"},"An example with IP intelligence data"),(0,r.kt)("p",null,"Let's walk through a real example of ingesting a common source of threat intelligence data: a dataset listing known good IPs. I have a file in JSON format as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{"ip": "1.1.1.1", "description": "CloudFlare\'s public DNS offering."}\n')),(0,r.kt)("p",null,"I add an enrichment table by creating a file in my ",(0,r.kt)("a",{parentName:"p",href:"/docs/matano-directory"},"Matano directory")," under ",(0,r.kt)("inlineCode",{parentName:"p"},"enrichment/known_ip_info/enrichment.yml"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},"# enrichment/known_ip_info/enrichment.yml\n\nname: known_ip_info\n\nenrichment_type: dynamic\nwrite_mode: append\n")),(0,r.kt)("p",null,"I specify the enrichment type as ",(0,r.kt)("em",{parentName:"p"},"dynamic"),", meaning I will upload the enrichment data to S3 for ingestion. You can also create ",(0,r.kt)("em",{parentName:"p"},"static")," enrichment tables where you can simply include the data inline as a file inside your Matano directory, without having to upload the data to S3."),(0,r.kt)("p",null,"I then define a schema for the enrichment table:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},"# enrichment/known_ip_info/enrichment.yml\n\nschema:\n  primary_key: ip\n  fields:\n    - name: ip\n      type: string\n    - name: description\n      type: string\n")),(0,r.kt)("p",null,"The definition is similar to that of a log source, but note that I can specify a primary key column for the enrichment table. This can later be used for lookup."),(0,r.kt)("p",null,"Let's see how I can use this enrichment table. Say I have a Python detection, and I want to lookup the IP in this known IP enrichment table to dynamically set the alert severity. I can add a lookup inside my Python detection and use this in the ",(0,r.kt)("inlineCode",{parentName:"p"},"severity")," function to set the alert severity as ",(0,r.kt)("inlineCode",{parentName:"p"},"info")," for events from known benign IPs."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'# detect.py\nfrom matano.enrichment import known_ip_info\n\ndef detect(r):\n    return (\n        "authentication" in r.deepget("event.category", [])\n        and r.deepget("event.outcome") == "failure"\n    )\n\ndef alert_context(r):\n    known_ip = known_ip_info.get(r.deepget("source.ip"))\n    r.is_known_ip = known_ip is not None\n\n    return {\n        "known_ip": known_ip\n    }\n\ndef title(r):\n    user_name, user_ip = r.deepget(\'user.name\'), r.deepget(\'source.ip\')\n    return f"Multiple failed logins from {user_name} - {user_ip}"\n\ndef severity(r):\n    if r.is_known_ip:\n        return "low"\n    else:\n        return "medium"\n\ndef dedupe(r):\n    return r.deepget("source.ip")\n')),(0,r.kt)("p",null,"Now we use our IP information to both dynamically lower the alert severity for known IPs and append IP intelligence to our alert for context."),(0,r.kt)("h3",{id:"another-example-with-aws-account-info"},"Another example with AWS account Info"),(0,r.kt)("p",null,"That's an example of using threat intelligence sources as enrichment tables. Let's also take a look at custom enrichment tables using internal sources of data. Consider an enrichment table ",(0,r.kt)("inlineCode",{parentName:"p"},"aws_account_info")," that provides configuration data related to our AWS accounts. We can use this inside our detections to, for example, determine if an AWS account is a production or development AWS account and enrich our alert context or set our alert severity."),(0,r.kt)("p",null,"Let's say our configuration data looks like so:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{"account_id": "123456789012", "name": "backend-prod", "is_production": true}\n{"account_id": "123456789012", "name": "frontend-dev", "is_production": false}\n')),(0,r.kt)("p",null,"We can create an enrichment table:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},"# enrichment/aws_account_info/enrichment.yml\nname: aws_account_info\nenrichment_type: dynamic\n\nschema:\n  primary_key: account_id\n  fields:\n    - name: account_id\n      type: string\n    - name: name\n      type: string\n    - name: is_production\n      type: boolean\n")),(0,r.kt)("p",null,"Let's consider a detection to detect disabling default Amazon Elastic Block Store (EBS) encryption. To reduce false positives, we want only apply this detection to production accounts. We can write the detection as so:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'from matano.enrichment import aws_account_info\n\ndef detect(r):\n    r.aws_acct_info = aws_account_info.get(r.deepget("cloud.account.id"))\n\n    # Detection only relevant for production accounts\n    if not r.aws_acct_info.get("is_production"):\n        return False\n\n    return (\n        r.deepget("event.provider") == "ec2.amazonaws.com"\n        and r.deepget("event.action") == "DisableEbsEncryptionByDefault"\n    )\n\ndef title(r):\n    acct_id, acct_name = r.deepget(\'cloud.account.id\'), r.aws_acct_info.get("name")\n    return f"Disable EBS encryption for AWS Account: {acct_id} - {acct_name}"\n\ndef dedupe(r):\n    return r.deepget("source.ip")\n')),(0,r.kt)("h2",{id:"up-next"},"Up next"),(0,r.kt)("p",null,"The initial release of enrichment tables is ready to use, and we'll be adding many improvements soon, including:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"More out of the box integrations, with threat intelligence feeds such as Abuse.CH, Greynoise, Geo IP (Maxminds), and more."),(0,r.kt)("li",{parentName:"ul"},"Enriching your log data inside VRL transformation using enrichment tables."),(0,r.kt)("li",{parentName:"ul"},"High performance matching against IoC's inside realtime detections.")),(0,r.kt)("p",null,"Follow and watch our ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/matanolabs/matano"},"GitHub repository")," and ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/orgs/matanolabs/projects/1"},"public roadmap")," for updates, and feel free to create an issue if you want to see something supported."))}p.isMDXComponent=!0},29332:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/sg-4bb83356eadaeb9f5134c093af374407.jpeg"},53909:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/sg-4bb83356eadaeb9f5134c093af374407.jpeg"}}]);